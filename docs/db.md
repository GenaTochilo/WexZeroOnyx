**Важно**: для локального тестирования, разработки, да и в целом работы билда база данных **не необходима**. Данная инструкция рассчитана на более продвинутые случаи или как общая информация к ознакомлению.

Также учитывайте, что используемая технология Docker может занимать довольно много места при активном использовании. Для простого запуска базы данных может уйти 1-2GB, но при частых перезапусках контейнеров, пересборках образов и так далее занимаемое место на диске может увеличиваться и до десятков гигабайт из-за кэшируемых файлов. Очистить место может быть не так просто из-за специфического расположения файлов Докера, потому обращайтесь к разработчикам проекта если вам нужна будет помощь. 

# Настройка базы данных

В билде ZeroOnyx используется MariaDB. Основная база данных билда называется `onyxdb`. В папке `tools/sql/` содержатся все необходимые файлы для работы с базой данных: Docker образ, схема базы данных и скрипты для запуска в Windows и Linux форматах.

## Быстрая инструкция (Windows)
- Установить Docker Desktop
- Запустить Docker Desktop
- Зайти в папку `tools/sql/`
- Двойным кликом запустить `build.bat`
- Двойным кликом запустить `run.bat`
- Перейти к секции [Конфигурация](#конфигурация) для последних шагов

## Первоначальная настройка
Все действия выполняются в папке `tools/sql/`

Необходимо установить `Docker`, для Windows это чаще всего просто `Docker Desktop`: https://www.docker.com/get-started/

Собрать образ:
- Для Windows можно просто двойным кликом запустить файл `build.bat`
- Альтернативно, можно воспользоваться терминалом, например `cmd (Command Prompt)` или, если установлен, `Git Bash`
```sh
# Зайти в папку sql если вы ещё не в ней
cd tools/sql/

# В случае cmd/Windows выполнить:
build.bat

# В случае Git Bash или Linux
./build.sh
```

Если на Windows возникают ошибки при выполнении, убедитесь что Docker Desktop запущен, его значок можно найти в трее. Сборка образа возможно только при запущенном Docker Engine, который запускается вместе с основным приложением автоматически. Если значок отсутствует, зайдите в меню пуск и запустите Docker Desktop.

В итоге вы должны увидеть подобные строки:
```
#8 exporting to image
#8 exporting layers 0.0s done
#8 writing image sha256:<hash>
#8 naming to docker.io/library/onyxdb done
#8 DONE 0.1s
```
а в конце сообщение об успехе:
```
Image built!
```

Вы также можете получить следующее предупреждение:
```
1 warning found (use docker --debug to expand):
 - SecretsUsedInArgOrEnv: Do not use ARG or ENV instructions for sensitive data (ENV "MARIADB_ROOT_PASSWORD") (line 5)
```
Покуда вы используете базу данных локально для тестирования или разработки, это предупреждение можно безопасно игнорировать.

Если же вы планируете хостить свой проект, ознакомьтесь с секцией [Продвинутое использование / Хостинг](#продвинутое-использование--хостинг). 

### Запуск

Как и в случае со сборкой образа, пользователи Windows могут запустить `run.bat` двойным кликом.

Альтернативно, запускаем через терминал:
```sh
# Зайти в папку sql если вы ещё не в ней
cd tools/sql/

# В случае cmd/Windows выполнить:
run.bat

# В случае Git Bash или Linux
./run.sh
```

В консоли могут появится ошибки:
```
Error response from daemon: No such container: onyxdb
Error: failed to start containers: onyxdb
```
Такие ошибки связаны с тем, что контейнер запускается в первый раз и не может найти старые контейнеры чтоб вычистить их. Эти ошибки можно безопасно игнорировать, скрипт продолжит работу сам.

Строка
```
Container started!
```
свидетельствуют об успешном запуске.

Если вы запускаете контейнер впервые, зайдите в Docker Desktop (или ваш аналог в зависимости от операционной системы и предпочтений), перейдите во вкладку Контейнеры (Containers) и убедитесь что спустя минуту он всё ещё работает (Status - Running). Это нужно из-за обработки файла схемы базы данных, что происходит при первом запуске. Остановившийся спустя минуту контейнер свидетельствует об ошибках во время запуска или обработки схемы, а потому следует зайти в интерфейс контейнера и проверить логи.


### Остановка

Остановить контейнер с базой данных вы можете через интерфейс Docker Desktop или с помощью команды:

```sh
docker stop onyxdb
```

## Конфигурация

Конфигурация базы данных расположена в файле `config/dbconfig.txt` (если нет - распакуйте из папки `config/example`). Из этого файла билд узнаёт куда надо подключаться и с каким логином/паролем.

По умолчанию конфигурация уже сделана под Docker образ и её можно не менять.

При успешном запуске базы данных можно включить связанные с базой данных функции в билде. Для этого в файле `config/config.toml` (который также нужно распаковать из `config/example/` если он отсутствует) выставляем те значения, которые вам нужны:
```sh
# Использовать систему администраторов из базы данных вместо файла config/admins.txt
admin_legacy_system = false
# Использовать систему банов из базы данных вместо файла data/banlist.bdb
ban_legacy_system = false
# Использовать вайтлист на расы помимо человека из базы данных вместо файла config/alienwhitelist.txt
use_alien_whitelist_sql = true
# Главная опция, которая контролирует использование базы данных билдом в целом. Если она не включена, билд не будет пытаться установить подключение к базе данных и рассчитывающий на неё функционал не будет работать.
sql_enabled = true
```

## Как выдать себе доступ администратора через базу данных

Стоит упомянуть, что даже с подключенной базой данных всё ещё можно использовать систему с admins.txt. За это отвечает параметр `admin_legacy_system` в конфигурации `config.toml`. В большинстве случаев этого достаточно для разработки или локального тестирования.

Если же вам нужен именно контроль прав через базу данных, необходимо добавить свой `ckey` и права в таблицу `admin`, пример:

| id  | ckey       | rank | flags |
| --- | ---------- | ---- | ----- |
| ... | <ваш_ckey> | Host | 65535 |

`ckey` - ваш `ckey`.

`rank` - ранг администратора, отображается в `adminwho`. `Host` - наивысший ранг.

`flags` - ваши права. Число `65535` даёт все возможные права. Удобнее подправить права под ваши конкретные нужды без разбирательств с числами и флагами можно будет из самой игры через команду `Permissions Panel`, при условии что игра успешно подключилась к базе данных и может редактировать записи.

### Что делать
Для данной инструкции предполагается что у вас система Windows, вы используете Docker Desktop, язык Docker Desktop выставлен как английский и конфигурация базы данных из предоставляемых скриптов не менялась.
- Собираем и запускаем контейнер по инструкциям выше
- Заходим во вкладку `Containers`
- Нажимаем на контейнер `onyxdb`
- Переходим во вкладку `Exec`
- В открывшемся окне с терминалом вписываем `mariadb -p`
- На появившийся запрос пароля вводим `pass` (во время набора пароля символы не будут отображаться, просто продолжайте вводить) и нажимаем Enter
- Наблюдаем запрос `MariaDB [(none)]>`, который будет означать что мы успешно подключились к базе данных
- Вводим команды:
  - `use onyxdb;`
  - `insert into admin(ckey, rank, flags) values('ваш_ckey', 'Host', 65535);`

Если видим `Query OK, 1 row affected`, вы успешно внесли себя в список администраторов. Дальшнейшее управление правами можно осуществлять из самой игры через команду `Permissions Panel`.

## Продвинутое использование / Хостинг

Хосты и разработчики могут выбрать любую другую совместимую БД путём редактирования докер-файла на подходящий образ.

Также возможно использование своей MySQL-совместимой БД по вкусу без применения Docker. Достаточно указать адрес вашей базы данных в `config/dbconfig.txt` и примененить схему из папки `tools/sql/schema/`. Рекомендуется проверить `tools/sql/Dockerfile` на предмет специальных инструкций, переменных окружения и параметров запуска для полной совместимости вашей внешей БД.

---

Настоятельно рекомендуется вместо стандартной конфигурации установить свои логин и пароль для базы данных.

---

Также обязательно разберитесь с созданием `Volume` для вашей базы данных, при том подходит как Named Volume, так и Host Folder Mounting. Это необходимо для сохранения информации в вашей базе данных даже если вы отключите или удалите контейнер. Подробнее можно узнать из официальных рекомендаций MariaDB:
- GitHub - [https://github.com/docker-library/docs/tree/master/mariadb#where-to-store-data](https://github.com/docker-library/docs/tree/master/mariadb#where-to-store-data)
- DockerHub [https://hub.docker.com/_/mariadb](https://hub.docker.com/_/mariadb), секция Where to Store Data.

---

Если вы запускаете собственную базу данных без докера, убедитесь что часовой пояс вашей базы данных выставлен на UTC. В противном случае привязанный к времени функционал игры или внешних ботов может перестать корректно функционировать. Например, системы банов, проверки мультиаккаунтов, верификации/соединения аккаунтов BYOND и Discord и т.д.
Подробнее по часовой пояс базы данных можно узнать из официальной документации: [https://mariadb.com/kb/en/time-zones/](https://mariadb.com/kb/en/time-zones/).
