# Настройка базы данных

В билде OnyxBay, а также в данном ответвлении OldOnyx, используются MySQL-подобные базы данных. В текущей версии билда используется MariaDB, но хосты могут выбрать любую другую совместимую БД путём редактирования докер-файла или просто запуска своей БД по вкусу и применения миграций из папки sql/migrate. В силу причин разделения доступа билд рассчитан на взаимодействие с двумя базами данных:

- OnyxDB - основная база данных.
- DonationsDB - в ней хранится информация о донатах, голосования, трекинг иссуев и прочее, слабо связанное с игровым процессом.

В папке `sql/` содержится Docker образ и схемы баз данных.

## Первоначальная настройка
Все действия выполняются в папке `sql/`

Необходимо установить `Docker`, для Windows это чаще всего просто `Docker Desktop`: https://www.docker.com/get-started/
Собрать образ:
- Для Windows можно просто двойным кликом запустить файл `build.bat`
- Альтернативно, можно воспользоваться терминалом, например `Command Prompt` или, если установлен, `Git Bash`
```sh
# Зайти в папку sql
cd OldOnyx/sql/

# В случае Windows выполнить:
build.bat

# В случае Git Bash или Linux
./build.sh
```

Если на Windows возникают ошибки при выполнении, убедитесь что Docker Desktop запущен, его значок можно найти в трее. Сборка образа возможно только при запущенном Docker Engine, который запускается вместе с основным приложением автоматически. Если значок отсутствует, зайдите в меню пуск и запустите Docker Desktop.

В итоге вы должны увидеть подобные строки:
```
#8 exporting to image
#8 exporting layers 0.0s done
#8 writing image sha256:<hash>
#8 naming to docker.io/library/onyxdb done
#8 DONE 0.1s
```
а в конце сообщение об успехе:
```
Image built!
```

Вы также можете получить следующее предупреждение:
```
1 warning found (use docker --debug to expand):
 - SecretsUsedInArgOrEnv: Do not use ARG or ENV instructions for sensitive data (ENV "MARIADB_ROOT_PASSWORD") (line 5)
```
но покуда вы используете базу данных локально для тестирования или разработки, это предупреждение можно безопасно игнорировать.

Если же вы планируете хостить свой проект, вы можете ознакомиться с рекомендациями по безопасности Docker и MariaDB в сети. 

### Запуск

Как и в случае со сборкой образа, пользователи Windows могут запустить `run.bat` двойным кликом. Альтернативно, запускаем через терминал:
```sh
# Зайти в папку sql если вы ещё не в ней
cd OldOnyx/sql/

# В случае Windows выполнить:
run.bat

# В случае Git Bash или Linux
./run.sh
```

В консоли могут появится ошибки:
```
Error response from daemon: No such container: onyxdb
Error: failed to start containers: onyxdb
```
Такие ошибки связаны с тем, что контейнер запускается в первый раз и их можно безопасно игнорировать.

Строка
```
Container started!
```
свидетельствуют об успешном запуске.

Если вы запускаете контейнер впервые, зайдите в Docker Desktop (или ваш аналог в зависимости от операционной системы и предпочтений), перейдите во вкладку Контейнеры (Containers) и убедитесь что спустя минуту он всё ещё работает (Status - Running/). Это нужно из-за обработки миграций и создания схемы базы данных, что происходит при первом запуске. Остановившийся спустя минутку-другую контейнер свидетельствует об ошибках во время запуска или обработки миграций, а потому следует зайти в интерфейс контейнера и проверить логи. 

### Остановка

Остановить контейнер с базой данных вы можете через интерфейс Docker Desktop или с помощью команды:

```sh
docker stop onyxdb
```

## Конфигурация

Конфигурация базы данных расположена в файле `config/dbconfig.txt` (если нет - распакуйте из папки `config/examples`). Из этого файла билд узнаёт куда надо подключаться и с каким логином/паролем.

По умолчанию конфигурация уже сделана под Docker образ и её не нужно трогать.

## Возможные проблемы

> Как сделать себя администратором если сервер использует базу данных вместо legacy системы с admins.txt?

Стоит упомянуть, что даже с подключенной базой данных всё ещё можно использовать систему с admins.txt. За это отвечает параметр `admin_legacy_system` в конфигурации `config.toml`. В большинстве случаев этого достаточно для разработки или локального тестирования.

Если же вам нужен именно контроль прав через базу данных, необходимо добавить свой `ckey` и права в таблицу `admin`, пример:

| id  | ckey       | rank | flags |
| --- | ---------- | ---- | ----- |
| ... | <ваш_ckey> | Host | 65535 |

`ckey` - ваш `ckey`.

`rank` - ранг администратора, отображается в `adminwho`. `Host` - наивысший ранг.

`flags` - ваши права. Число `65535` даёт все возможные права. Удобнее подправить права под ваши конкретные нужды без разбирательств с числами и флагами можно будет из самой игры через команду `Permissions Panel`, при условии что игра успешно подключилась к базе данных и может редактировать записи.
